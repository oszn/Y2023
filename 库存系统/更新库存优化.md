# 库存优化

虽然走的是缓存，但是对于持久化部分可以进行部分优化，如果有1k次update once，那么数据库压力会很大，这些操作完全可以在前置中进行优化。

## 拉取逻辑

发送的库存的时候，讲内容按照commodity_id发送到相同的区域，然后采用多个线程消费分区内容。这样可以保证不会有冲突，批量拉取可以库存的吞吐下降，同步更快。



目前困难时batch消费的时候，如何能做到代码的复用，batch消费的原理是将多批次的消息进行合并，之消费一次。但是拉取逻辑还是相同的，需要修改的部分是多个部分。例如一次性拉取多条消息，使用的还是相同的抽取，如何让后续感知到是批量处理了。



常规消息队列过程

1. 接受MqMO此时结果未解析，字符串。
2. 通过MO的msgtype和subtype寻找到对应的处理工具。
3. 处理工具对字符串进行解析，得到对应的对象(MqMsgBO).
4. 对应的处理工具处理。



批量处理难点在于，首先消息未解析，批量过程未确定，映射过程未确定。需要加中间层，在哪里加是一个问题，或者说舍弃掉这些内容，直接使用新的mq消息，在新的mq消息里解决这种问题.